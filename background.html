<script>
    var kwSearch = {
        
        findBookmarks: function (regex, text, callback) {

            var maxDepth = localStorage["__depth__"] || 5;
            var results = [];

            chrome.bookmarks.search(text, function (matched) {
                for (var i = 0; i < matched.length && results.length < maxDepth; i++) {
                    if(matched[i].title && regex.test(matched[i].title)) {
                        results.push(matched[i]);
                    }
                }
                callback(results);
            });
        },

        loadUrl: function (url) {
            var newTab = localStorage["__newtab__"];
            
            chrome.tabs.getSelected(null, function (tab) {
                if (tab != null && newTab != "true" || tab.url == "chrome://newtab/") {
                    chrome.tabs.update(tab.id, {url: url});
                } else {
                    chrome.tabs.create({url: url});
                }
            });
        },

        getSuggestion: function (bookmarks, text) {
            return bookmarks.map(function (bookmark){
                var t = bookmark.title;
                var re = new RegExp("(" + text + ")");
                
                return {
                    content: bookmark.url,
                    description: 'Open ' + (re.test(t) ? t.replace(re, '<match>' + RegExp.$1 +'</match>') : '<match>' + t + '</match>')
                };
            });
        },

        getRegExp: function(text) {
            var regExp = localStorage["__regexp__"];
            var reCase = localStorage["__regexpcase__"];
        
            if (reCase != "true") {
                reCase = "i";
            } else {
                reCase = null;
            }
            var r = new RegExp('^\\[' + text + '.*\\]', reCase);
        
            if (regExp) {
                r = new RegExp(regExp.replace(/%s/g, text), reCase);
            }

            return r;
        }
    };
    
    chrome.omnibox.onInputChanged.addListener(function (text, suggest) {
        if (!text) {
            return;
        }
        kwSearch.findBookmarks(kwSearch.getRegExp(text), text, function (results){
            suggest(kwSearch.getSuggestion(results, text));
        });
    });

    chrome.omnibox.onInputEntered.addListener(function (text) {
        if (!text) {
            return;
        }
        if (/(^http:|^https:|^javascript:)/.test(text)) {
            kwSearch.loadUrl(text);
        }
        
        kwSearch.findBookmarks(kwSearch.getRegExp(text), text, function (results) {
            if (results.length > 0) {
                kwSearch.loadUrl(results[0].url);
            } 
        });
    });

</script>
